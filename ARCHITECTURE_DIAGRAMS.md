# Implementation Architecture & Flow Diagrams\n\n## System Architecture\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                    Flutter Mobile App                        │\n│                                                               │\n│  ┌──────────────────┐         ┌──────────────────┐          │\n│  │  Order Summary   │         │  Waiting For     │          │\n│  │  Page            │────────▶│  Payment Page    │          │\n│  │                  │         │                  │          │\n│  └────────┬─────────┘         └────────┬─────────┘          │\n│           │                            │                     │\n│  ┌────────▼──────────┐      ┌──────────▼──────┐             │\n│  │ CartProvider      │      │ WaitingFor...   │             │\n│  │ fetchDeliveryFee()│      │ _onSuccess()    │             │\n│  └───────────────────┘      │ _onFailure()    │             │\n│                              └────────┬────────┘             │\n│                                       │                      │\n│  ┌───────────────────────────────────▼──────────────────┐   │\n│  │         OrderApi (API Layer)                         │   │\n│  │  - getDeliveryFee()                                  │   │\n│  │  - updateOrderPaymentStatus()                        │   │\n│  │  - momoRequest()                                     │   │\n│  │  - momoStatus()                                      │   │\n│  └──────┬──────────────────────┬──────────────┬─────────┘   │\n│         │                      │              │              │\n└─────────┼──────────────────────┼──────────────┼──────────────┘\n          │                      │              │\n          ▼                      ▼              ▼\n    ┌──────────────┐      ┌────────────┐  ┌──────────────┐\n    │   Backend    │      │  Backend   │  │   Backend    │\n    │ Delivery API │      │ Payment    │  │ Order Status │\n    │              │      │ API        │  │ API          │\n    │GET /api/     │      │PUT /api/   │  │PUT /api/     │\n    │restaurants/  │      │v1/payments │  │orders/{id}/  │\n    │{id}/         │      │momo/       │  │updatePayment │\n    │delivery-fee  │      │request     │  │Status        │\n    └──────────────┘      └────────────┘  └──────────────┘\n```\n\n---\n\n## Delivery Fee Workflow\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                     DELIVERY FEE WORKFLOW                         │\n└─────────────────────────────────────────────────────────────────┘\n\n1. USER NAVIGATES TO ORDER SUMMARY PAGE\n   │\n   ▼\n2. OrderSummaryPage.initState() executes\n   │\n   ├─ _momoController.text = widget.selectedNumber\n   │\n   └─ _fetchDeliveryFee()  ◀── NEW\n      │\n      ▼\n3. CartProvider.fetchDeliveryFee() called\n   │\n   ├─ Check if currentRestaurantId is valid\n   │\n   └─ Call OrderApi.getDeliveryFee(restaurantId)\n      │\n      ▼\n4. HTTP GET /api/restaurants/{restaurantId}/delivery-fee\n   │\n   ├─ 200 OK ──▶ Parse response\n   │             │\n   │             ├─ Check for 'deliveryFee' field\n   │             ├─ Check for 'fee' field\n   │             └─ Check for 'amount' field\n   │\n   │             ▼\n   │             Store in _deliveryFee\n   │\n   │             ▼\n   │             notifyListeners() ──▶ UI rebuilds\n   │\n   └─ Error ──▶ Log warning\n                 │\n                 ▼\n                 Set _deliveryFee = 0.0\n                 │\n                 ▼\n                 Continue (non-blocking)\n\n5. UI DISPLAYS UPDATED TOTALS\n   │\n   ├─ finalAmount = subTotal + deliveryFee - discount\n   │\n   └─ User sees correct final amount with delivery fee\n\n```\n\n---\n\n## Payment Status State Machine\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│           PAYMENT STATUS STATE TRANSITIONS                        │\n└─────────────────────────────────────────────────────────────────┘\n\n\n                    ┌─────────────┐\n                    │  INITIAL    │\n                    │  (Backend)  │\n                    │  PENDING    │\n                    └──────┬──────┘\n                           │\n                 (Order created successfully)\n                           │\n                           ▼\n                    ┌─────────────┐\n                    │ PROCESSING  │ ◀── updateOrderPaymentStatus()\n                    │ (Updating   │     called right after order\n                    │  payment    │     creation in OrderSummary\n                    │  status)    │\n                    └──────┬──────┘\n                           │\n              ┌────────────┴────────────┐\n              │                         │\n      (User accepts        (User rejects\n       MoMo request)        or timeout)\n              │                         │\n              ▼                         ▼\n       ┌──────────────┐         ┌──────────────┐\n       │ COMPLETED    │         │    FAILED    │\n       │              │         │              │\n       │ (MoMo        │         │ (Payment     │\n       │  success)    │         │  failed)     │\n       │              │         │              │\n       │ updateOrder  │         │ updateOrder  │\n       │ PaymentStatus│         │ PaymentStatus│\n       │ (COMPLETED)  │         │ (FAILED)     │\n       └──────┬───────┘         └──────┬───────┘\n              │                         │\n              └────────────┬────────────┘\n                           │\n                           ▼\n                    User checks Orders page\n                    Sees correct payment status\n\n\nKEY:\n  ◀── = API method call\n  └─▶ = Automatic transition\n```\n\n---\n\n## Complete Order Lifecycle\n\n```\n╔════════════════════════════════════════════════════════════════╗\n║              COMPLETE ORDER + PAYMENT LIFECYCLE                ║\n╚════════════════════════════════════════════════════════════════╝\n\n\nPHASE 1: ORDER PREPARATION\n┌──────────────────────────────────────────────────────────────┐\n│                                                                │\n│ ┌─────────────┐    ┌────────────────┐    ┌──────────────┐   │\n│ │  Browsing   │───▶│ Add to Cart     │───▶│ Order Summary│   │\n│ │ Restaurants │    │ (CartProvider)  │    │ Page Loads   │   │\n│ └─────────────┘    └────────────────┘    └──────┬───────┘   │\n│                                                  │            │\n│ ACTION: _fetchDeliveryFee() ─────────────────────┘            │\n│                                                                │\n│ ┌─────────────────────────────────────────────────────────┐  │\n│ │ GET /api/restaurants/{id}/delivery-fee                  │  │\n│ │ Response: { deliveryFee: 500 }                          │  │\n│ │ → finalAmount = 5000 + 500 = 5500 RWF                   │  │\n│ └─────────────────────────────────────────────────────────┘  │\n│                                                                │\n└──────────────────────────────────────────────────────────────┘\n\nPHASE 2: ORDER CREATION\n┌──────────────────────────────────────────────────────────────┐\n│                                                                │\n│ ┌─────────────┐    ┌────────────────┐                        │\n│ │ Review Order│───▶│ Place Order    │                        │\n│ └─────────────┘    │ (API Call)     │                        │\n│                    └────────┬───────┘                        │\n│                             │                                │\n│ ┌──────────────────────────▼──────────────────────────────┐ │\n│ │ POST /api/orders/createOrder                           │ │\n│ │ Response: {\n│ │   orderId: 123,\n│ │   paymentStatus: \"PENDING\",\n│ │   orderStatus: \"PLACED\"\n│ │ }\n│ └────────────────────┬─────────────────────────────────────┘ │\n│                      │\n│ ACTION: updateOrderPaymentStatus() ───────────────────────────┤\n│                      │                                         │\n│ ┌──────────────────▼────────────────────────────────────────┐ │\n│ │ PUT /api/orders/123/updatePaymentStatus                 │ │\n│ │ Body: { paymentStatus: \"PROCESSING\" }                   │ │\n│ │ Response: { ...order with paymentStatus: PROCESSING }    │ │\n│ └─────────────────────────────────────────────────────────┘ │\n│                                                                │\n└──────────────────────────────────────────────────────────────┘\n\nPHASE 3: PAYMENT PROCESSING\n┌──────────────────────────────────────────────────────────────┐\n│                                                                │\n│ ┌──────────────┐    ┌───────────────┐    ┌──────────────┐   │\n│ │ Select MOMO  │───▶│ Initiate MoMo │───▶│ Waiting Page │   │\n│ │ Payment      │    │ Request       │    │ (Polling)    │   │\n│ └──────────────┘    └───────┬───────┘    └──────┬───────┘   │\n│                             │                   │            │\n│ ┌──────────────────────────▼──────────────────▼────────────┐ │\n│ │ POST /api/v1/payments/momo/request                       │ │\n│ │ GET /api/v1/payments/momo/status/{id} (polling)          │ │\n│ └────────────────────────────────────────────────────────────┘ │\n│                                                                │\n└──────────────────────────────────────────────────────────────┘\n\nPHASE 4A: PAYMENT SUCCESS\n┌──────────────────────────────────────────────────────────────┐\n│                                                                │\n│ User accepts MoMo request on phone                            │\n│                        │                                       │\n│ ┌──────────────────────▼──────────────────────────────────┐  │\n│ │ WaitingForPaymentPage._onSuccess() called              │  │\n│ │                                                          │  │\n│ │ ACTION: updateOrderPaymentStatus() ──────────────────┐ │  │\n│ │                                                      │ │  │\n│ │ ┌──────────────────────────────────────────────────▼┐ │  │\n│ │ │ PUT /api/orders/123/updatePaymentStatus         │ │  │\n│ │ │ Body: { paymentStatus: \"COMPLETED\" }           │ │  │\n│ │ │ Response: { ...order with paymentStatus: COMPLETED }│  │\n│ │ └─────────────────────────────────────────────────┘ │  │\n│ │                                                      │  │\n│ │ Navigate to Orders page ────────────────┐           │  │\n│ │                                         │           │  │\n│ │ User sees order with status: COMPLETED  │           │  │\n│ └─────────────────────────────────────────┼───────────┘  │\n│                                           │              │\n└───────────────────────────────────────────┼──────────────┘\n                                            │\n                                            ▼\n                                    ✅ ORDER COMPLETE\n\nPHASE 4B: PAYMENT FAILURE\n┌──────────────────────────────────────────────────────────────┐\n│                                                                │\n│ User rejects MoMo request or timeout occurs                  │\n│                        │                                       │\n│ ┌──────────────────────▼──────────────────────────────────┐  │\n│ │ WaitingForPaymentPage._onFailure() called              │  │\n│ │                                                          │  │\n│ │ ACTION: updateOrderPaymentStatus() ──────────────────┐ │  │\n│ │                                                      │ │  │\n│ │ ┌──────────────────────────────────────────────────▼┐ │  │\n│ │ │ PUT /api/orders/123/updatePaymentStatus         │ │  │\n│ │ │ Body: { paymentStatus: \"FAILED\" }              │ │  │\n│ │ │ Response: { ...order with paymentStatus: FAILED }  │  │\n│ │ └─────────────────────────────────────────────────┘ │  │\n│ │                                                      │  │\n│ │ Navigate to Orders page ────────────────┐           │  │\n│ │                                         │           │  │\n│ │ User sees order with status: FAILED     │           │  │\n│ └─────────────────────────────────────────┼───────────┘  │\n│                                           │              │\n└───────────────────────────────────────────┼──────────────┘\n                                            │\n                                            ▼\n                                    ❌ PAYMENT FAILED\n                                       (Can retry)\n\n```\n\n---\n\n## Code Call Stack\n\n```\nUSER INTERACTION\n    │\n    ▼\nOrderSummaryPage.initState()\n    │\n    ├─ _momoController.text = widget.selectedNumber\n    │\n    └─ _fetchDeliveryFee()\n       │\n       └─ CartProvider.fetchDeliveryFee()\n          │\n          └─ OrderApi.getDeliveryFee(restaurantId)\n             │\n             └─ http.get(\"/api/restaurants/{id}/delivery-fee\")\n                │\n                └─ Parse response → _deliveryFee\n                   │\n                   └─ notifyListeners() → UI rebuilds\n\nOrderSummaryPage._placeOrder()\n    │\n    └─ OrderApi.createOrder(...)\n       │\n       └─ http.post(\"/api/orders/createOrder\")\n          │\n          └─ OrderResponse received\n             │\n             └─ OrderApi.updateOrderPaymentStatus(\n                   orderId, \"PROCESSING\"\n                )\n                │\n                └─ http.put(\"/api/orders/{id}/updatePaymentStatus\")\n\nWaitingForPaymentPage._startPolling()\n    │\n    ├─ Timer.periodic(3 seconds)\n    │  │\n    │  └─ OrderApi.momoStatus(requestId)\n    │     │\n    │     └─ http.get(\"/api/v1/payments/momo/status/{id}\")\n    │        │\n    │        └─ Check status\n    │           │\n    │           ├─ SUCCESS ──▶ _onSuccess()\n    │           │              │\n    │           │              └─ OrderApi.updateOrderPaymentStatus(\n    │           │                   orderId, \"COMPLETED\"\n    │           │                )\n    │           │\n    │           └─ FAILED ───▶ _onFailure()\n    │                          │\n    │                          └─ OrderApi.updateOrderPaymentStatus(\n    │                              orderId, \"FAILED\"\n    │                           )\n    │\n    └─ If max attempts reached ──▶ _onTimeout()\n\n```\n\n---\n\n## Data Models\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│            CART PROVIDER STATE                              │\n├─────────────────────────────────────────────────────────────┤\n│                                                              │\n│  _deliveryFee: double = 0.0     ◀── UPDATED by fetch API   │\n│  _isLoadingDeliveryFee: bool = false                        │\n│  _currentRestaurantId: int? = null                          │\n│  _items: List<CartItem> = []                               │\n│                                                              │\n│  Computed:\n│  finalAmount = subTotal + deliveryFee - discount           │\n│                                                              │\n└─────────────────────────────────────────────────────────────┘\n\n┌─────────────────────────────────────────────────────────────┐\n│            ORDER MODEL                                       │\n├─────────────────────────────────────────────────────────────┤\n│                                                              │\n│  orderId: int?                                              │\n│  orderNumber: string?                                       │\n│  orderStatus: string?                                       │\n│  paymentStatus: string?     ◀── UPDATED by API calls       │\n│                                 PENDING → PROCESSING       │\n│                                        → COMPLETED/FAILED   │\n│  deliveryFee: double?                                       │\n│  finalAmount: double?                                       │\n│  paymentMethod: string?                                     │\n│  ... (other fields)                                         │\n│                                                              │\n└─────────────────────────────────────────────────────────────┘\n\n```\n\n---\n\n## Error Handling Flow\n\n```\n┌──────────────────────────────────────────────────────────────┐\n│         ERROR HANDLING STRATEGY                               │\n├──────────────────────────────────────────────────────────────┤\n│                                                               │\n│  ALL API CALLS ARE NON-BLOCKING                             │\n│                                                               │\n│  ┌────────────────────────────────────────────────────────┐ │\n│  │ Delivery Fee Fetch Fails                               │ │\n│  ├────────────────────────────────────────────────────────┤ │\n│  │ Action: Log warning                                    │ │\n│  │ Fallback: _deliveryFee = 0.0                          │ │\n│  │ Result: User can still checkout (fee = 0)             │ │\n│  │ Impact: LOW - Order continues normally                │ │\n│  └────────────────────────────────────────────────────────┘ │\n│                                                               │\n│  ┌────────────────────────────────────────────────────────┐ │\n│  │ Payment Status Update Fails (PROCESSING)              │ │\n│  ├────────────────────────────────────────────────────────┤ │\n│  │ Action: Log error as warning                          │ │\n│  │ Fallback: Continue order flow                         │ │\n│  │ Result: Order created but status not updated          │ │\n│  │ Impact: LOW - Payment still proceeds                  │ │\n│  └────────────────────────────────────────────────────────┘ │\n│                                                               │\n│  ┌────────────────────────────────────────────────────────┐ │\n│  │ Payment Status Update Fails (COMPLETED/FAILED)        │ │\n│  ├────────────────────────────────────────────────────────┤ │\n│  │ Action: Log error as warning                          │ │\n│  │ Fallback: Continue to Orders page                     │ │\n│  │ Result: Order status may not reflect payment result   │ │\n│  │ Impact: MEDIUM - Status not updated but order exists  │ │\n│  │ Recovery: Admin can manually update status in DB      │ │\n│  └────────────────────────────────────────────────────────┘ │\n│                                                               │\n│  ┌────────────────────────────────────────────────────────┐ │\n│  │ MoMo Payment Fails (Network)                           │ │\n│  ├────────────────────────────────────────────────────────┤ │\n│  │ Action: Show error dialog                             │ │\n│  │ Fallback: Allow user to retry payment                 │ │\n│  │ Result: Payment retried or abandoned                  │ │\n│  │ Impact: EXPECTED - User chooses retry                 │ │\n│  └────────────────────────────────────────────────────────┘ │\n│                                                               │\n└──────────────────────────────────────────────────────────────┘\n\n```\n\n